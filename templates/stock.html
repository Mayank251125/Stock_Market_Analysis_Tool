<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/stock.css') }}">
    <title>Stock Price Prediction</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* (styles remain the same) */
        .realtime-data-section {
            margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 8px;
            text-align: left; border: 1px solid #e9ecef;
        }
        .realtime-data-section h2 {
            color: #0056b3; font-size: 1.5em; margin-bottom: 10px;
        }
        .realtime-data-item {
            font-size: 1.1em; margin-bottom: 5px;
        }
        .realtime-data-item strong {
            color: #333;
        }
        .price-up { color: #28a745; font-weight: bold; }
        .price-down { color: #dc3545; font-weight: bold; }
        .price-neutral { color: #6c757d; }
        .loading-indicator {
            display: none; margin: 20px auto; text-align: center;
        }
        .spinner {
            border: 6px solid #f3f3f3; border-top: 6px solid #3498db;
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
            display: inline-block; vertical-align: middle; margin-right: 15px;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }
        .loading-text {
            color: #333; font-size: 1.3em; font-weight: bold; vertical-align: middle;
        }
        /* --- ADD THIS CODE --- */
        .sentiment-result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9f5ff;
            border-left: 5px solid #0056b3;
            border-radius: 8px;
            text-align: left;
        }
        .sentiment-result h3 {
            font-size: 1.4em;
            color: #0056b3;
            margin-top: 0;
            margin-bottom: 5px;
        }
        .sentiment-result p {
            font-size: 1.6em;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        /* --- END OF ADDED CODE --- */
 
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .app-logo {
            display: block; margin: 0 auto 20px auto; width: 120px; height: 120px;
            border-radius: 50%; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            object-fit: cover;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <img src="https://placehold.co/120x120/0056b3/ffffff?text=Stock" alt="Stock App Logo" class="app-logo">
        <h1>Stock Price Prediction</h1>
        <form id="stockForm" method="post" onsubmit="send_data(event)">
            <label for="stock_ticker">Stock Ticker (e.g., ^NSEI, GOOG, BTC-USD)</label>
            <input type="text" id="stock_ticker" name="stock_ticker" required placeholder="^NSEI, GOOG, MSFT, BTC-USD">
            <button type="submit" class="btn">Predict Next Day's Open Price</button>
        </form>
        <div id="loading" class="loading-indicator">
            <div class="spinner"></div>
            <span class="loading-text">Predicting...</span>
        </div>
        <div id="prediction" class="prediction-result"></div>

        <div id="sentiment-container" class="sentiment-result" style="display:none;">
            <h3>Market Sentiment</h3>
            <p id="sentiment-label">--</p>
        </div>
        <div id="realtimeCryptoInfo" class="realtime-data-section" style="display:none;">
            <h2>Live Crypto Price</h2>
            <div class="realtime-data-item">Current Price: <span id="cryptoCurrentPrice"></span></div>
            <div class="realtime-data-item">24hr Change: <span id="crypto24hrChange"></span></div>
        </div>
        <div id="realtimeStockInfo" class="realtime-data-section" style="display:none;">
            <h2>Live Stock Price</h2>
            <div class="realtime-data-item">Current Price: <span id="stockCurrentPrice"></span></div>
            <div class="realtime-data-item">Daily Change: <span id="stockDailyChange"></span></div>
        </div>
        <div id="companyInfo" class="company-info-section" style="display:none;">
            <h2>Company Information</h2>
            <p><strong>Name:</strong> <span id="companyName"></span> (<span id="companySymbol"></span>)</p>
            <p><strong>Market Cap:</strong> <span id="companyMarketCap"></span></p>
            <p><strong>Volume:</strong> <span id="companyVolume"></span></p>
        </div>
        <div class="chart-container" style="display:none;">
            <h2>Historical Price Chart</h2>
            <canvas id="priceChart"></canvas>
        </div>
    </div>
    <script>
        let myChart = null;
        function send_data(event) {
            event.preventDefault();
            document.getElementById("prediction").innerHTML = "";
            document.getElementById("companyInfo").style.display = 'none'; 
            document.querySelector(".chart-container").style.display = 'none';
            document.getElementById("realtimeCryptoInfo").style.display = 'none';
           document.getElementById("realtimeStockInfo").style.display = 'none';
            document.getElementById("loading").style.display = 'block';

            // --- ADD THIS LINE ---
            document.getElementById("sentiment-container").style.display = 'none';

            var form = document.getElementById('stockForm');
            document.getElementById("loading").style.display = 'block';
            var form = document.getElementById('stockForm');
            var formData = new FormData(form);
            var xhr = new XMLHttpRequest();
            const apiUrl = window.location.origin + '/predict_close';
            if (window.location.protocol === 'file:') {
                document.getElementById("prediction").innerHTML = "Prediction Error: Please run the Flask server (`python main.py`) and access via `http://127.0.0.1:5000/predict_close`.";
                document.getElementById("loading").style.display = 'none';
                return;
            }
            xhr.open('POST', apiUrl, true);
            xhr.setRequestHeader('Accept', 'application/json');
            xhr.onreadystatechange = function () {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    document.getElementById("loading").style.display = 'none';
                    if (xhr.status === 200) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            console.log("Full Response:", response);
                            // FIXED: Displays the raw number from the backend
                            // This line already exists in your file
                            document.getElementById("prediction").innerHTML = "Predicted Next Day's Open Price: " + response.prediction.toFixed(2);

                            // --- ADD THIS CODE ---
                            if (response.sentiment && response.sentiment.label) {
                                document.getElementById("sentiment-label").innerText = response.sentiment.label;
                                document.getElementById("sentiment-container").style.display = "block";
                            }
                            // --- END OF ADDED CODE ---
                            
                            const realTimeCryptoData = response.real_time_crypto_data;
                            const realTimeStockData = response.real_time_stock_data; 
                            const isCrypto = response.is_crypto;
                            if (realTimeCryptoData) {
                                document.getElementById("realtimeCryptoInfo").style.display = 'block';
                                document.getElementById("realtimeStockInfo").style.display = 'none'; 
                                // FIXED: Displays the raw number from the backend with toFixed(2)
                                document.getElementById("cryptoCurrentPrice").textContent = realTimeCryptoData.current_price.toFixed(2);
                                const changeElement = document.getElementById("crypto24hrChange");
                                if (realTimeCryptoData.change_24hr !== undefined && realTimeCryptoData.change_24hr !== null) {
                                    const changeText = `${realTimeCryptoData.change_24hr.toFixed(2)}%`;
                                    changeElement.textContent = changeText;
                                    changeElement.className = '';
                                    if (realTimeCryptoData.change_24hr > 0) {
                                        changeElement.classList.add('price-up');
                                    } else if (realTimeCryptoData.change_24hr < 0) {
                                        changeElement.classList.add('price-down');
                                    } else {
                                        changeElement.classList.add('price-neutral');
                                    }
                                } else {
                                    changeElement.textContent = 'N/A';
                                    changeElement.className = 'price-neutral';
                                }
                            } else if (realTimeStockData) {
                                document.getElementById("realtimeStockInfo").style.display = 'block';
                                document.getElementById("realtimeCryptoInfo").style.display = 'none'; 
                                // FIXED: Displays the raw number from the backend with toFixed(2)
                                document.getElementById("stockCurrentPrice").textContent = realTimeStockData.current_price.toFixed(2);
                                const changeElement = document.getElementById("stockDailyChange");
                                if (realTimeStockData.change_24hr !== undefined && realTimeStockData.change_24hr !== null) {
                                    const changeText = `${realTimeStockData.change_24hr.toFixed(2)}%`;
                                    changeElement.textContent = changeText;
                                    changeElement.className = '';
                                    if (realTimeStockData.change_24hr > 0) {
                                        changeElement.classList.add('price-up');
                                    } else if (realTimeStockData.change_24hr < 0) {
                                        changeElement.classList.add('price-down');
                                    } else {
                                        changeElement.classList.add('price-neutral');
                                    }
                                } else {
                                    changeElement.textContent = 'N/A';
                                    changeElement.className = 'price-neutral';
                                }
                            }
                            const companyInfo = response.company_info;
                            const companyInfoSection = document.getElementById("companyInfo");
                            if (companyInfo && companyInfo.longName !== 'N/A' && companyInfo.longName !== null) {
                                companyInfoSection.style.display = 'block';
                                document.getElementById("companyName").textContent = String(companyInfo.longName);
                                document.getElementById("companySymbol").textContent = String(companyInfo.symbol);
                                document.getElementById("companyMarketCap").textContent = String(companyInfo.marketCap);
                                document.getElementById("companyVolume").textContent = String(companyInfo.volume);
                            } else {
                                companyInfoSection.style.display = 'none';
                            }
                            const chartData = response.chart_data;
                            if (chartData.labels && chartData.labels.length > 0 && chartData.prices && chartData.prices.length > 0) {
                                document.querySelector(".chart-container").style.display = 'block';
                                const ctx = document.getElementById('priceChart').getContext('2d');
                                if (myChart) {
                                    myChart.destroy();
                                }
                                myChart = new Chart(ctx, {
                                    type: 'line',
                                    data: {
                                        labels: chartData.labels,
                                        datasets: [{
                                            label: 'Close Price',
                                            data: chartData.prices,
                                            borderColor: 'rgb(75, 192, 192)',
                                            tension: 0.1,
                                            fill: false
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        scales: {
                                            x: {
                                                type: 'category',
                                                labels: chartData.labels,
                                                title: { display: true, text: 'Date' }
                                            },
                                            y: {
                                                beginAtZero: false,
                                                title: { display: true, text: 'Price' }
                                            }
                                        }
                                    }
                                });
                            } else {
                                console.log("No valid chart data to display.");
                                document.querySelector(".chart-container").style.display = 'none';
                            }
                        } catch (e) {
                            document.getElementById("prediction").innerHTML = "Prediction Error: Failed to parse server response. " + e.message;
                            console.error("Error parsing JSON response:", e);
                            console.error("Raw response:", xhr.responseText);
                        }
                    } else {
                        document.getElementById("prediction").innerHTML = "Prediction Error: " + xhr.responseText;
                        console.error("Server responded with error status:", xhr.status, xhr.responseText);
                    }
                }
            }
            xhr.send(formData);
        }
    </script>
</body>
</html>